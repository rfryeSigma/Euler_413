"""
I am trying to understand how to go from an A, B, C, D solution to
an Elliptic Curve and it's (m, n) parameterization.

I gave Gemini equations 3b,c from Elkies' paper.

I gave Gemini detailed instructions:
--------------
Write a python function. Given a tuple (A,B,C,D), 
choose the odd A, B, C and call it c. 
Consider possibilities for fraction t = +/- c/D. 
Call the even pair, a, b. 
Consider possibilities for fraction r = +/- a/D, +/- b/D. 
Consider posibilities for fraction s = +- the other even term. 
For all combinations of r, s, t, 
compute fractions x = (r+s)/2, y = (r-s)/2. 
Solve the two equations for integer m, n in the possible x, y. 
Report all choices and results. 
There should be a pair with positive m, a multiple of 4, and n odd.

For A, B, C, D = (2_682_440, 15_365_639, 18_796_760, 20_615_673), 
one of the reported pairs should turn out to be (8, -5), 
but do not use that information in the code; 
do not select from possible (m,n) pairs.
-----------------

It turns out I don't have to consider negative t nor swap r, s 
because the signs compensate, so produce duplicates.

It reports 4 results including (8, -5) for Elkies solution.
I think the other results may be useful 
when searching for other solutions on same fiber.

% python -m elliptical.solve_for_mn
Found 4 solutions for (2682440, 15365639, 18796760, 20615673)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
2682440/20615673     | 18796760/20615673    | 15365639/20615673    | (340912, 2136525)
2682440/20615673     | -18796760/20615673   | 15365639/20615673    | (8, -5)
-2682440/20615673    | 18796760/20615673    | 15365639/20615673    | (2211506178056, 40143752605885)
-2682440/20615673    | -18796760/20615673   | 15365639/20615673    | (199797104, -46747125)
"""
from fractions import Fraction
import math

def solve_for_mn(A, B, C, D):
    # Identify odd (c) and even (a, b) terms
    terms = [A, B, C]
    odds = [x for x in terms if x % 2 != 0]
    assert 1 == len(odds)
    t_raw = odds[0]
    evens = [x for x in terms if x % 2 == 0]
    assert 2 == len(evens)
    r_raw, s_raw = evens[0], evens[1]
    
    D_f = Fraction(D)
    results = []

    # Iterate through possibilities for r, s
    # r = +/- a/D
    # s = +/- b/D
    t = Fraction(t_raw, D)
    for r_sign in [1, -1]:
        r = r_sign * Fraction(r_raw, D)
        for s_sign in [1, -1]:
            s = s_sign * Fraction(s_raw, D)
            
            # Compute x and y
            x = (r + s) / 2
            y = (r - s) / 2
            
            # Solve Elkies Equation (3c) for u = m/n
            # Equation: +/- (2u^2 + 1)t^2 = 4(2u^2 - 1)x^2 + 8ux + (1 - 2u^2)
            # Select + version
            # Rearranged as Au^2 + Bu + C = 0:
            # u^2 * [2t^2 - 8x^2 + 2] + u * [-8x] + [t^2 + 4x^2 - 1] = 0
            quad_A = 2*t**2 - 8*x**2 + 2
            if 0 == quad_A:
                print('zero quadA')
                continue
            quad_B = -8*x
            quad_C = t**2 + 4*x**2 - 1
            
            # Solve quadratic: u = (-B +/- sqrt(B^2 - 4AC)) / 2A
            discriminant = quad_B**2 - 4*quad_A*quad_C
            
            if 0 >=  discriminant:
                print('Negative or zero discriminant')
                continue
            # Check if discriminant is a perfect square of a Fraction
            num, den = discriminant.numerator, discriminant.denominator
            root_num = math.isqrt(num)
            root_den = math.isqrt(den)
            
            if not(root_num * root_num == num and root_den * root_den == den):
                print('Discriminant not perfect square')
                continue
            sqrt_disc = Fraction(root_num, root_den)
            
            for sol_sign in [1, -1]:
                try:
                    k = (-quad_B + sol_sign * sqrt_disc) / (2 * quad_A)
                    
                    # Verify solution with Equation (3b)
                    # (2k^2 + 1)y^2 + (6k^2 - 8k + 3)x^2 + 2(2k^2 - 1)x + 2k = 0
                    check = (2*k**2 + 1)*y**2 + (6*k**2 - 8*k + 3)*x**2 + 2*(2*k**2 - 1)*x + 2*k
                    
                    if check != 0:
                        # print('Fail Equation (3b)')
                        continue
                    # Simplify k = m/n to integers
                    m, n = k.numerator, k.denominator
                    if m % 4 != 0:
                        assert n % 4 == 0
                        m, n = n, m
                    if m < 0:
                        m, n = -m, -n
                    assert math.gcd(m, n) == 1

                    # Record this choice
                    results.append({
                        "r": r, "s": s, "t": t,
                        "x": x, "y": y,
                        "m": m, "n": n
                    })
                except ZeroDivisionError:
                    print('Zero division')
                    continue
    print(f'Found {len(results)} solutions for {(A, B, C, D)}')
    return results

def report_rstmn(results):
    # Report results
    print(f"{'r':<20} | {'s':<20} | {'t':<20} | {'(m, n)':<10}")
    print("-" * 80)
    for res in results:
        print(f"{str(res['r']):<20} | {str(res['s']):<20} | {str(res['t']):<20} | ({res['m']}, {res['n']})")

def main(argv=None):
    from solutions import known
    mn = dict() # (m, n) -> [key1, key2, ...]
    for key in known.keys():
        print(f'\n{key}')
        results = solve_for_mn(*known[key]['abcd'])
        report_rstmn(results)
        for d in results:
            m, n = d['m'], d['n']
            l = mn.get((m, n), [])
            l.append(key)
            mn[(m, n)] = l
    print('Keys on multiple fibers')
    for (m, n), l in mn.items():
        if 1 < len(l):
            print(m, n, l)
if __name__ == "__main__":
    main()

"""
F42248_6
Found 4 solutions for (95800, 217519, 414560, 422481)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
95800/422481         | 414560/422481        | 217519/422481        | (48940, 330353)
95800/422481         | -414560/422481       | 217519/422481        | (20, -9)
-95800/422481        | 414560/422481        | 217519/422481        | (369596780, -6899820729)
-95800/422481        | -414560/422481       | 217519/422481        | (660460, 52463)

M28130_7
Found 4 solutions for (673865, 1390400, 2767624, 2813001)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
1390400/2813001      | 2767624/2813001      | 673865/2813001       | (6692, 34225)
1390400/2813001      | -2767624/2813001     | 673865/2813001       | (3375081700, -2270288673)
-1390400/2813001     | 2767624/2813001      | 673865/2813001       | (412, -1425)
-1390400/2813001     | -2767624/2813001     | 673865/2813001       | (367240100, 130344703)

B87074_7
Found 4 solutions for (1705575, 5507880, 8332208, 8707481)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
5507880/8707481      | 8332208/8707481      | 1705575/8707481      | (121333308, 544434589)
5507880/8707481      | -8332208/8707481     | 1705575/8707481      | (1352800221524, -1219868668869)
-5507880/8707481     | 8332208/8707481      | 1705575/8707481      | (12, -29)
-5507880/8707481     | -8332208/8707481     | 1705575/8707481      | (244444, 103611)

T12197_8
Found 4 solutions for (5870000, 8282543, 11289040, 12197457)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
5870000/12197457     | 11289040/12197457    | 8282543/12197457     | (457280, 1867333)
5870000/12197457     | -11289040/12197457   | 8282543/12197457     | (80, -93)
-5870000/12197457    | 11289040/12197457    | 8282543/12197457     | (158785763120, -1010819791893)
-5870000/12197457    | -11289040/12197457   | 8282543/12197457     | (117135680, 20632147)

B16003_8
Found 4 solutions for (4479031, 12552200, 14173720, 16003017)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
12552200/16003017    | 14173720/16003017    | 4479031/16003017     | (6860848, 27660845)
12552200/16003017    | -14173720/16003017   | 4479031/16003017     | (102731297224, -136084052085)
-12552200/16003017   | 14173720/16003017    | 4479031/16003017     | (568, -1005)
-12552200/16003017   | -14173720/16003017   | 4479031/16003017     | (17426416, 7919435)

B16430_8
Found 4 solutions for (3642840, 7028600, 16281009, 16430513)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
3642840/16430513     | 7028600/16430513     | 16281009/16430513    | (45498888, 220096985)
3642840/16430513     | -7028600/16430513    | 16281009/16430513    | (3803742704, -21484187145)
-3642840/16430513    | 7028600/16430513     | 16281009/16430513    | (432, 12185)
-3642840/16430513    | -7028600/16430513    | 16281009/16430513    | (598856, -956745)

E20615_8
Found 4 solutions for (2682440, 15365639, 18796760, 20615673)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
2682440/20615673     | 18796760/20615673    | 15365639/20615673    | (340912, 2136525)
2682440/20615673     | -18796760/20615673   | 15365639/20615673    | (8, -5)
-2682440/20615673    | 18796760/20615673    | 15365639/20615673    | (2211506178056, 40143752605885)
-2682440/20615673    | -18796760/20615673   | 15365639/20615673    | (199797104, -46747125)

G44310_8
Found 4 solutions for (2164632, 31669120, 41084175, 44310257)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
2164632/44310257     | 31669120/44310257    | 41084175/44310257    | (17530520620, 103878389409)
2164632/44310257     | -31669120/44310257   | 41084175/44310257    | (660, -817)
-2164632/44310257    | 31669120/44310257    | 41084175/44310257    | (225388398548, 1701832006545)
-2164632/44310257    | -31669120/44310257   | 41084175/44310257    | (12396, -12065)

G68711_8
Found 4 solutions for (10409096, 42878560, 65932985, 68711097)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
10409096/68711097    | 42878560/68711097    | 65932985/68711097    | (9200036, 45186013)
10409096/68711097    | -42878560/68711097   | 65932985/68711097    | (9788, -21021)
-10409096/68711097   | 42878560/68711097    | 65932985/68711097    | (17373563356, 190621456389)
-10409096/68711097   | -42878560/68711097   | 65932985/68711097    | (66997508, -68923973)

G11711_9
Found 4 solutions for (34918520, 87865617, 106161120, 117112081)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
34918520/117112081   | 106161120/117112081  | 87865617/117112081   | (5442892, 25607745)
34918520/117112081   | -106161120/117112081 | 87865617/117112081   | (19835764, -18948825)
-34918520/117112081  | 106161120/117112081  | 87865617/117112081   | (11587212, -431691625)
-34918520/117112081  | -106161120/117112081 | 87865617/117112081   | (638841996, -29915585)

R14508_9
Found 4 solutions for (1841160, 121952168, 122055375, 145087793)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
1841160/145087793    | 121952168/145087793  | 122055375/145087793  | (223701720, 1612727957)
1841160/145087793    | -121952168/145087793 | 122055375/145087793  | (8618438678704, -5782194519405)
-1841160/145087793   | 121952168/145087793  | 122055375/145087793  | (240, 1861)
-1841160/145087793   | -121952168/145087793 | 122055375/145087793  | (10250072, -6393885)

R15664_9
Found 4 solutions for (27450160, 108644015, 146627384, 156646737)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
27450160/156646737   | 146627384/156646737  | 108644015/156646737  | (3885556, 23685689)
27450160/156646737   | -146627384/156646737 | 108644015/156646737  | (91783281432452, -55070924098809)
-27450160/156646737  | 146627384/156646737  | 108644015/156646737  | (4, 201)
-27450160/156646737  | -146627384/156646737 | 108644015/156646737  | (1130360308, -127476361)

T58984_9
Found 4 solutions for (186668000, 260052385, 582665296, 589845921)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
186668000/589845921  | 582665296/589845921  | 260052385/589845921  | (66200, 398113)
186668000/589845921  | -582665296/589845921 | 260052385/589845921  | (154346386421048, -80003585351025)
-186668000/589845921 | 582665296/589845921  | 260052385/589845921  | (200, -1617)
-186668000/589845921 | -582665296/589845921 | 260052385/589845921  | (1176672027032, 221455047775)

M63852_9
Found 4 solutions for (219076465, 275156240, 630662624, 638523249)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
275156240/638523249  | 630662624/638523249  | 219076465/638523249  | (13263640, 70543053)
275156240/638523249  | -630662624/638523249 | 219076465/638523249  | (8, -5)
-275156240/638523249 | 630662624/638523249  | 219076465/638523249  | (7291645404120760, -32932164796565677)
-275156240/638523249 | -630662624/638523249 | 219076465/638523249  | (8685217112, 2585664795)

G87382_9
Found 4 solutions for (558424440, 606710871, 769321280, 873822121)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
558424440/873822121  | 769321280/873822121  | 606710871/873822121  | (8616272140, 31423350069)
558424440/873822121  | -769321280/873822121 | 606710871/873822121  | (129780, -214309)
-558424440/873822121 | 769321280/873822121  | 606710871/873822121  | (676124096620, -2536491008349)
-558424440/873822121 | -769321280/873822121 | 606710871/873822121  | (39676140, 10044211)

G12597_10
Found 4 solutions for (588903336, 859396455, 1166705840, 1259768473)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
588903336/1259768473 | 1166705840/1259768473 | 859396455/1259768473 | (2616746156, 10793427489)
588903336/1259768473 | -1166705840/1259768473 | 859396455/1259768473 | (36, -41)
-588903336/1259768473 | 1166705840/1259768473 | 859396455/1259768473 | (3573601424093852, -24289306570764009)
-588903336/1259768473 | -1166705840/1259768473 | 859396455/1259768473 | (213405228, 35048399)

T16791_10
Found 4 solutions for (50237800, 632671960, 1670617271, 1679142729)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
50237800/1679142729  | 632671960/1679142729 | 1670617271/1679142729 | (342037111025920, 2470757267153601)
50237800/1679142729  | -632671960/1679142729 | 1670617271/1679142729 | (17513240, -68433257)
-50237800/1679142729 | 632671960/1679142729 | 1670617271/1679142729 | (4434806360, 38513823913)
-50237800/1679142729 | -632671960/1679142729 | 1670617271/1679142729 | (320, -1041)

G17878_10
Found 4 solutions for (686398000, 1237796960, 1662997663, 1787882337)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
686398000/1787882337 | 1237796960/1787882337 | 1662997663/1787882337 | (1172429320, 4510540073)
686398000/1787882337 | -1237796960/1787882337 | 1662997663/1787882337 | (920, -2433)
-686398000/1787882337 | 1237796960/1787882337 | 1662997663/1787882337 | (34489459435880, -1162770995686593)
-686398000/1787882337 | -1237796960/1787882337 | 1662997663/1787882337 | (697603720, -250475353)

G18717_10
Found 4 solutions for (92622401, 1553556440, 1593513080, 1871713857)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
1553556440/1871713857 | 1593513080/1871713857 | 92622401/1871713857  | (7942024, 33007785)
1553556440/1871713857 | -1593513080/1871713857 | 92622401/1871713857  | (1475142449425136, -2029072334435105)
-1553556440/1871713857 | 1593513080/1871713857 | 92622401/1871713857  | (592, -865)
-1553556440/1871713857 | -1593513080/1871713857 | 92622401/1871713857  | (201753127112, 96827989095)

T33936_10
Found 4 solutions for (664793200, 2448718655, 3134081336, 3393603777)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
664793200/3393603777 | 3134081336/3393603777 | 2448718655/3393603777 | (712772, 4037701)
664793200/3393603777 | -3134081336/3393603777 | 2448718655/3393603777 | (692, -477)
-664793200/3393603777 | 3134081336/3393603777 | 2448718655/3393603777 | (208475561657044, 11965813153064277)
-664793200/3393603777 | -3134081336/3393603777 | 2448718655/3393603777 | (3125517064484, -381568856429)

T15434_11
Found 4 solutions for (140976551, 5821981400, 15355831360, 15434547801)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
5821981400/15434547801 | 15355831360/15434547801 | 140976551/15434547801 | (1871618540, 12210228313)
5821981400/15434547801 | -15355831360/15434547801 | 140976551/15434547801 | (20, -9)
-5821981400/15434547801 | 15355831360/15434547801 | 140976551/15434547801 | (1841388704670375980, -8186158063860766089)
-5821981400/15434547801 | -15355831360/15434547801 | 140976551/15434547801 | (28089906860, 8609774023)

T29999_14
Found 4 solutions for (7592431981391, 22495595284040, 27239791692640, 29999857938609)
r                    | s                    | t                    | (m, n)    
--------------------------------------------------------------------------------
22495595284040/29999857938609 | 27239791692640/29999857938609 | 7592431981391/29999857938609 | (24900916820, 102362428537)
22495595284040/29999857938609 | -27239791692640/29999857938609 | 7592431981391/29999857938609 | (3500, -4209)
-22495595284040/29999857938609 | 27239791692640/29999857938609 | 7592431981391/29999857938609 | (58559932384378531034900, -111086849627630929773009)
-22495595284040/29999857938609 | -27239791692640/29999857938609 | 7592431981391/29999857938609 | (16377532166458580, 7404925027952887)

Keys on multiple fibers
20 -9 ['F42248_6', 'T15434_11']
8 -5 ['E20615_8', 'M63852_9']
"""
"""
E91617_71 (m,n)
(189473325609396679236539280669707366855142915566595322186069044697936, 1010824743679443623984598253256240057091154168396595802152140063644525)
(8, -5)
(1892213352665364754528641501088712019594972839968086708354202406593464069758490740310141761326330857897070703695860069700667846738419912696, -6469782978098116921062725135828000036253497719447454194230884935989637431030999827796062091058295171827146670105002910139512650363483275965)
(130718695727212495242926386552952515301926766161385571981796581831287312, 46953649528708124196653285293517679571813107629473787565794753952674475)
"""
